<%inherit file="base.html"/>
<%!
  from headphones import db
%>

<%def name="headerIncludes()">
  <div id="subhead_container">
    <ul id="subhead_menu">
      <li><a href="refreshArtist?id=${artist['id']}">Refresh Artist</a></li>
      <li><a href="deleteArtist?id=${artist['id']}">Delete Artist</a></li>
      %if artist['state'] == 'paused':
        <li><a href="resumeArtist?id=${artist['id']}">Resume Artist</a></li>
      %else:
        <li><a href="pauseArtist?id=${artist['id']}">Pause Artist</a></li>
      %endif
    </ul>
  </div>
</%def>

<%def name="body()">
  <form action="markAlbums" method="get"><input type="hidden" name="ArtistID" value=${artist['id']}>
    <div class="table_wrapper table_sorting">
      <h1 class="left">${artist['name']}</h1>
      %if artist['state'] == 'loading':
        <p> (Album information for this artist is currently being loaded)</p>
      %endif

      <p class="right">Mark selected albums as 
        <select name="action">
            <option value="Wanted">Wanted</option>
            <option value="WantedNew">Wanted (new only)</option>
            <option value="Skipped">Skipped</option>
            <option value="Downloaded">Downloaded</option>
        </select>
        <input type="submit" value="Go">
      </p>

      <table class="display" id="album_table">
        <thead>
          <tr>
            <th id="select"><input type="checkbox" onClick="toggle(this)" /></th>
            <th id="albumart"></th>
            <th id="albumname">Name</th>
            <th id="reldate">Date</th>
            <th id="type">Type</th>
            <th id="state">State</th>
            <th id="have">Have</th>
            <th id="bitrate">Bitrate</th>
          </tr>
        </thead>
        <tbody>
        %for album in albums:
          <%
            if album['state'] == 'skipped':
              grade = 'Z'
            elif album['state'] == 'wanted':
              grade = 'X'
            elif album['state'] == 'snatched':
              grade = 'C'
            else:
              grade = 'A'

            myDB = db.DBConnection()
            totaltracks = len(myDB.select('SELECT title from tracks WHERE album_id=?', [album['id']]))
            havetracks = len(myDB.select('SELECT title from tracks WHERE album_id=? AND location IS NOT NULL', [album['id']]))
            try:
              percent = (havetracks*100.0)/totaltracks
              if percent > 100:
                percent = 100
            except (ZeroDivisionError, TypeError):
              percent = 0
              totaltracks = '?'

            avgbitrate = myDB.action("SELECT AVG(bit_rate) FROM tracks WHERE album_id=?", [album['id']]).fetchone()[0]
            if avgbitrate:
              bitrate = str(int(avgbitrate)/1000) + ' kbps'
            else:
              bitrate = ''
          %>
          <tr class="grade${grade}">
            <td id="select"><input type="checkbox" name="${album['id']}" class="checkbox" /></td>
            <td id="albumart"><img src="http://ec1.images-amazon.com/images/P/${album['id']}.01.MZZZZZZZ.jpg" height="50" width="50"></td>
            <td id="albumname"><a href="album?id=${album['id']}">${album['title']}</a></td>
            <td id="reldate">${album['ReleaseDate']}</td>
            <td id="type">${album['type']}</td>
            <td id="status">${album['state']}
            %if album['state'] == 'skipped':
              [<a href="queueAlbum?album_id=${album['id']}&album_id=${album['artist_id']}">want</a>]
            %elif album['state'] == 'wanted':
              [<a href="unqueueAlbum?album_id=${album['id']}&album_id=${album['artist_id']}">skip</a>]
            %else:
              [<a href="queueAlbum?album_id=${album['id']}&album_id=${album['artist_id']}" title="Retry the same download again">retry</a>][<a href="queueAlbum?album_id=${album['id']}&artist_id=${album['artist_id']}&new=True" title="Try a new download, skipping all previously tried nzbs">new</a>]
            %endif
            </td>
            <td id="have"><span title="${percent}"><span><div class="progress-container"><div style="width:${percent}%"><div class="havetracks">${havetracks}/${totaltracks}</div></div></div></td>
            <td id="bitrate">${bitrate}</td>
          </tr>
        %endfor
        </tbody>
      </table>
    </div>
  </form>
</%def>

<%def name="headIncludes()">
  <link rel="stylesheet" href="css/data_table.css">
</%def>

<%def name="javascriptIncludes()">
  <script src="js/libs/jquery.dataTables.min.js"></script>
  <script>
    $(document).ready(function()
    {
      $('#album_table').dataTable(
        {
          "aoColumns": [
            { "bSortable": false },
            { "bSortable": false },
            null,
            null,
            { "bSortable": false },
            null,
            { "sType": "title-numeric"},
            null
          ],
          "oLanguage": {
            "sLengthMenu":"Show _MENU_ albums per page",
            "sEmptyTable": "No album information available",
            "sInfo":"Showing _TOTAL_ albums",
            "sInfoEmpty":"Showing 0 of 0 albums",
            "sInfoFiltered":"(filtered from _MAX_ total albums)"},
          "bPaginate": false,
          "aaSorting": [[4, 'asc'],[3,'desc']]
        });
    });
  </script>
</%def>
